# =============================================================================
# SENSORS - Home Assistant State Synchronization
# =============================================================================
# This file creates sensors that monitor Home Assistant entities and update
# the touchscreen buttons to reflect the current state of your smart devices.
#
# WHY THIS FILE EXISTS:
# When you press a button on the touchscreen, it sends a command to Home
# Assistant. But what if someone turns on a light using their phone, or a
# scene activates automatically? This file ensures the touchscreen display
# always shows the ACTUAL state of each device, not just what was last pressed.
#
# HOW IT WORKS:
# 1. Each sensor subscribes to a Home Assistant entity (switch, sensor, etc.)
# 2. When that entity's state changes, the "on_state" or "on_value" trigger fires
# 3. The trigger updates the corresponding button in lvgl.yaml to show the new state
#
# KEY CONCEPTS:
# - "platform: homeassistant" = reads state directly from Home Assistant
# - "platform: template" = calculates a value using code (lambda)
# - "entity_id:" = the Home Assistant device/entity to monitor
# - "id:" = unique name to reference this sensor elsewhere in ESPHome
# - "trigger_on_initial_state: true" = update button immediately when device boots
# - "lvgl.widget.update" = changes how a button looks on screen
# - "checked: !lambda return x;" = x is the sensor's boolean state (true/false)
#
# RELATIONSHIP TO lvgl.yaml:
# Each sensor here has a matching button in lvgl.yaml:
#   - This file READS state from Home Assistant → updates button appearance
#   - lvgl.yaml SENDS commands to Home Assistant → when button is pressed
# =============================================================================


# =============================================================================
# REGULAR SENSORS (Numeric Values)
# =============================================================================
# These sensors read numeric values like temperature and position.
# They're used to display information or calculate other states.
# =============================================================================

sensor:

  # ===========================================================================
  # SENSOR: Office Temperature (Indoor)
  # ===========================================================================
  # WHAT IT MONITORS:
  #   The temperature inside the office from sensor.office_temperature
  #   (This could be from a smart thermostat, dedicated sensor, etc.)
  #
  # WHAT IT UPDATES:
  #   The "temperatures" label in the top-left corner of the screen
  #   Format: "outdoor° / indoor°" (e.g., "15° / 22°")
  #
  # HOW IT WORKS:
  #   When the office temperature changes in Home Assistant, this sensor
  #   receives the new value and updates the label text. It combines the
  #   outdoor temperature (from the other sensor below) with this value.
  #
  # RELATED UI ELEMENT:
  #   lvgl.yaml → temperatures label (id: temperatures)
  # ===========================================================================
  - platform: homeassistant
    entity_id: sensor.air_quality_monitor_temperature
    id: lounge_temperature
    on_value:
      - lvgl.label.update:
          id: temperatures
          text:
            format: "%d° / %d°"
            args: [ '(int)round(id(openweathermap_temperature).state)', '(int)round(x)' ]

  # ===========================================================================
  # SENSOR: Outdoor Temperature
  # ===========================================================================
  # WHAT IT MONITORS:
  #   The temperature outside from sensor.outdoor_temperature
  #   (This could be from a weather service, outdoor sensor, etc.)
  #
  # WHAT IT UPDATES:
  #   The "temperatures" label in the top-left corner of the screen
  #   Format: "outdoor° / indoor°" (e.g., "15° / 22°")
  #
  # HOW IT WORKS:
  #   When the outdoor temperature changes in Home Assistant, this sensor
  #   receives the new value and updates the label text. It combines this
  #   value with the office temperature (from the sensor above).
  #
  # NOTE: Both temperature sensors update the same label. Either one changing
  #       will refresh the display with both current values.
  #
  # RELATED UI ELEMENT:
  #   lvgl.yaml → temperatures label (id: temperatures)
  # ===========================================================================
  - platform: homeassistant
    entity_id: sensor.openweathermap_temperature
    id: openweathermap_temperature
    on_value:
      - lvgl.label.update:
          id: temperatures
          text:
            format: "%d° / %d°"
            args: [ '(int)round(x)', '(int)round(id(lounge_temperature).state)' ]

  # ===========================================================================
  # SENSOR: Office Blind Position
  # ===========================================================================
  # WHAT IT MONITORS:
  #   The current position of the office window blind (0-100%)
  #   Reads the "current_position" attribute from cover.curtain_robot_front_door
  #
  # WHAT IT'S USED FOR:
  #   This sensor doesn't directly update buttons. Instead, it provides
  #   the position value that the template sensors below use to determine
  #   which blind button should be highlighted.
  #
  # WHY IT'S SEPARATE:
  #   The blind has 4 preset buttons (0%, 33%, 66%, 100%), but the blind
  #   could be at ANY position. This sensor stores the actual position,
  #   and the template sensors below check if it's "close enough" to each
  #   preset (within 3%) to highlight that button.
  #
  # RELATED UI ELEMENTS:
  #   lvgl.yaml → curtain_robot_front_door_open_button, curtain_robot_front_door_66_button,
  #               curtain_robot_front_door_33_button, curtain_robot_front_door_close_button
  # ===========================================================================
  - platform: homeassistant
    entity_id: cover.curtain_robot_front_door
    id: curtain_robot_front_door_position
    attribute: current_position

  - platform: homeassistant
    entity_id: cover.curtain_robot_kitchen
    id: curtain_robot_kitchen_position
    attribute: current_position

  # ===========================================================================
  # SENSOR: Centauri Carbon Print Progress
  # ===========================================================================
  # WHAT IT MONITORS:
  #   Current print progress percent from Home Assistant
  #   Watches: sensor.centauri_carbon_percent_complete_helper
  #
  # WHAT IT UPDATES:
  #   The print progress label inside the "Printer" button
  #
  # RELATED UI ELEMENT:
  #   lvgl.yaml → print_progress_label
  # ===========================================================================
  #- platform: homeassistant
  #  entity_id: sensor.centauri_carbon_percent_complete_helper
  #  id: centauri_carbon_percent
  #  on_value:
  #    - lvgl.label.update:
  #        id: print_progress_label
  #        text:
  #          format: "%.0f"
  #          args: [ 'x' ]

  # ===========================================================================
  # SENSOR: Filament Heater Humidity
  # ===========================================================================
  # WHAT IT MONITORS:
  #   Current humidity percent from the filament dryer sensor
  #   Watches: sensor.office_filament_heater_sensor_humidity
  #
  # WHAT IT UPDATES:
  #   The humidity label inside the "Dryer" button
  #
  # RELATED UI ELEMENT:
  #   lvgl.yaml → dryer_humidity_label
  # ===========================================================================
  #- platform: homeassistant
  #  entity_id: sensor.office_filament_heater_sensor_humidity
  #  id: filament_heater_humidity
  #  on_value:
  #    - lvgl.label.update:
  #        id: dryer_humidity_label
  #        text:
  #          format: "%.0f"
  #          args: [ 'x' ]



# =============================================================================
# BINARY SENSORS (On/Off States)
# =============================================================================
# These sensors track on/off states and update button appearances.
# When the sensor is ON (true), the button shows as "checked" (highlighted).
# When the sensor is OFF (false), the button shows as unchecked (dimmed).
# =============================================================================

binary_sensor:

  # ===========================================================================
  # SENSOR: Office Evening Scene Active
  # ===========================================================================
  # WHAT IT MONITORS:
  #   Whether the "Evening" lighting scene is currently active
  #   Watches: binary_sensor.office_scene_evening in Home Assistant
  #
  # WHAT IT UPDATES:
  #   The "Evening" button's visual state (highlighted when active)
  #
  # HOW IT WORKS:
  #   Home Assistant has a binary sensor that's ON when the evening scene
  #   is active. When this changes, the button appearance updates to match.
  #   "trigger_on_initial_state: true" ensures the button shows correctly
  #   right when the device boots up, not just when state changes later.
  #
  # RELATED UI ELEMENT:
  #   lvgl.yaml → office_scene_evening_button
  # ===========================================================================
  #- platform: homeassistant
  #  id: office_scene_evening
  #  entity_id: binary_sensor.office_scene_evening
  #  trigger_on_initial_state: true
  #  on_state:
  #    then:
  #      lvgl.widget.update:
  #        id: office_scene_evening_button
  #        state:
  #          checked: !lambda return x;

  # ===========================================================================
  # SENSOR: Office Dimmed Scene Active
  # ===========================================================================
  # WHAT IT MONITORS:
  #   Whether the "Dimmed" lighting scene is currently active
  #   Watches: binary_sensor.office_scene_dimmed in Home Assistant
  #
  # WHAT IT UPDATES:
  #   The "Dimmed" button's visual state (highlighted when active)
  #
  # RELATED UI ELEMENT:
  #   lvgl.yaml → office_scene_dimmed_button
  # ===========================================================================
  #- platform: homeassistant
  #  id: office_scene_dimmed
  #  entity_id: binary_sensor.office_scene_dimmed
  #  trigger_on_initial_state: true
  #  on_state:
  #    then:
  #      lvgl.widget.update:
  #        id: office_scene_dimmed_button
  #        state:
  #          checked: !lambda return x;

  # ===========================================================================
  # SENSOR: Office Calls Scene Active
  # ===========================================================================
  # WHAT IT MONITORS:
  #   Whether the "Calls" (video call) lighting scene is currently active
  #   Watches: binary_sensor.office_scene_desk_call in Home Assistant
  #
  # WHAT IT UPDATES:
  #   The "Calls" button's visual state (highlighted when active)
  #
  # RELATED UI ELEMENT:
  #   lvgl.yaml → office_scene_calls_button
  # ===========================================================================
  #- platform: homeassistant
  #  id: office_scene_desk_call
  #  entity_id: binary_sensor.office_scene_desk_call
  #  trigger_on_initial_state: true
  #  on_state:
  #    then:
  #      lvgl.widget.update:
  #        id: office_scene_calls_button
  #        state:
  #          checked: !lambda return x;

  # ===========================================================================
  # Automation: Desk LED's
  # ===========================================================================
  # WHAT IT MONITORS:
  #   Whether the "Features" (LED accent) lighting scene is currently active
  #   Watches: automation.office_scene_features in Home Assistant
  #
  # WHAT IT UPDATES:
  #   The "Features" button's visual state (highlighted when active)
  #
  # RELATED UI ELEMENT:
  #   lvgl.yaml → automation_led_s_desk_button
  # ===========================================================================
  - platform: homeassistant
    id: automation_led_s_desk
    entity_id: binary_sensor.led_s_desk_features
    trigger_on_initial_state: true
    on_state:
      then:
        lvgl.widget.update:
          id: automation_led_s_desk_button
          state:
            checked: !lambda return x;

  # ===========================================================================
  # SENSOR: 3D Printer Power State
  # ===========================================================================
  # WHAT IT MONITORS:
  #   Whether the 3D printer's smart plug is turned on or off
  #   Watches: switch.office_3d_printer_power in Home Assistant
  #
  # WHAT IT UPDATES:
  #   The "Printer" button's visual state (highlighted when powered on)
  #
  # NOTE: This monitors a "switch" entity but uses binary_sensor platform.
  #       ESPHome treats the switch's on/off state as a binary value here.
  #
  # RELATED UI ELEMENT:
  #   lvgl.yaml → printer_power_button
  # ===========================================================================
  #- platform: homeassistant
  #  id: office_3d_printer_power
  #  entity_id: switch.office_3d_printer_power
  #  trigger_on_initial_state: true
  #  on_state:
  #    then:
  #      - lvgl.widget.update:
  #          id: printer_power_button
  #          state:
  #            checked: !lambda return x;
  #      - lvgl.widget.update:
  #          id: printer_power_icon
  #          hidden: !lambda return x;
  #      - lvgl.widget.update:
  #          id: print_progress_container
  #          hidden: !lambda return !x;

  # ===========================================================================
  # SENSOR: Air Conditioner State
  # ===========================================================================
  # WHAT IT MONITORS:
  #   Whether the office air conditioner is running
  #   Watches: switch.office_air_conditioner in Home Assistant
  #
  # WHAT IT UPDATES:
  #   The "Aircon" button's visual state (highlighted when running)
  #
  # RELATED UI ELEMENT:
  #   lvgl.yaml → office_aircon_button
  # ===========================================================================
  - platform: homeassistant
    id: lounge_light_fan
    entity_id: script.lounge_light_fan
    trigger_on_initial_state: false
    on_state:
      then:
        - lvgl.widget.update:
            id: lounge_fan_button
            state:
              checked: !lambda return x;
        #- lvgl.widget.update:
        #    id: lounge_light_fan_power_button
        #    state:
        #      checked: !lambda return x;
        #- lvgl.widget.update:
        #    id: aircon_lab_power_button
        #    state:
        #      checked: !lambda return x;
        #- lvgl.widget.update:
        #    id: aircon_temp_up_button
        #    hidden: !lambda return !x;
        #- lvgl.widget.update:
        #    id: aircon_temp_down_button
        #    hidden: !lambda return !x;
        #- lvgl.widget.update:
        #    id: aircon_set_temp_button
        #    hidden: !lambda return !x;

  # ===========================================================================
  # SENSOR: Air Fryer State
  # ===========================================================================
  # WHAT IT MONITORS:
  #   Whether the Air Fryer's smart plug is turned on or off
  #   Watches: switch.plug_kitchen_boiler in Home Assistant
  #
  # WHAT IT UPDATES:
  #   The "Air Fryer" button's visual state (highlighted when powered on)
  #
  # RELATED UI ELEMENT:
  #   lvgl.yaml → air_fryer_button
  # ===========================================================================
  - platform: homeassistant
    id: kitchen_air_fryer
    entity_id: switch.plug_kitchen_boiler
    trigger_on_initial_state: true
    on_state:
      then:
        lvgl.widget.update:
          id: air_fryer_button
          state:
            checked: !lambda return x;

  # ===========================================================================
  # SENSOR: Lounge Ceiling Light State
  # ===========================================================================
  # WHAT IT MONITORS:
  #   Whether the Lounge Ceiling Light is turned on or off
  #   Watches: script.lounge_light_toggle in Home Assistant
  #
  # WHAT IT UPDATES:
  #   The "Ceiling" button's visual state (highlighted when running)
  #
  # RELATED UI ELEMENT:
  #   lvgl.yaml → lounge_light_button
  # ===========================================================================
  - platform: homeassistant
    id: lounge_light_toggle
    entity_id: script.lounge_light_toggle
    trigger_on_initial_state: true
    on_state:
      then:
        - lvgl.widget.update:
            id: lounge_light_button
            state:
              checked: !lambda return x;
        - lvgl.widget.update:
            id: lounge_light_icon
            hidden: !lambda return x;
            

  # ===========================================================================
  # TEMPLATE SENSOR: Curtain at 100% (Fully Open)
  # ===========================================================================
  # WHAT IT DOES:
  #   Calculates whether the blind is at (or very close to) 100% open
  #   Returns TRUE if position is within 3% of 100, FALSE otherwise
  #
  # WHY USE A TEMPLATE:
  #   The curtain motor may not stop at exactly 100%. It might be 99% or 101%.
  #   This template uses a 3% tolerance to account for this imprecision.
  #   If position is between 97-100%, we consider it "fully open".
  #
  # HOW THE CODE WORKS:
  #   1. Check if curtain_robot_front_door_position has received a value yet
  #   2. Calculate: |current_position - 100| <= 3
  #   3. Return true if within range, false otherwise
  #
  # WHAT IT UPDATES:
  #   The "Open" button's visual state (highlighted when blind is ~100%)
  #
  # RELATED UI ELEMENT:
  #   lvgl.yaml → curtain_robot_front_door_open_button
  # ===========================================================================
  - platform: template
    id: curtain_robot_front_door_100
    lambda: |-
      if (id(curtain_robot_front_door_position).has_state()) {
        return abs(id(curtain_robot_front_door_position).state - 100) <= 3;
      }
      return false;
    on_state:
      then:
        lvgl.widget.update:
          id: curtain_robot_front_door_open_button
          state:
            checked: !lambda return x;

  # Sensor for Curtain robot - Kitchen
  - platform: template
    id: curtain_robot_kitchen_0
    lambda: |-
      if (id(curtain_robot_kitchen_position).has_state()) {
        return abs(id(curtain_robot_kitchen_position).state - 0) <= 3;
      }
      return false;
    on_state:
      then:
        lvgl.widget.update:
          id: curtain_robot_kitchen_open_button
          state:
            checked: !lambda return x;



  # ===========================================================================
  # TEMPLATE SENSOR: Blind at 66% (Semi Open)
  # ===========================================================================
  # WHAT IT DOES:
  #   Calculates whether the blind is at (or very close to) 66% open
  #   Returns TRUE if position is within 3% of 66, FALSE otherwise
  #
  # HOW THE CODE WORKS:
  #   Same logic as above, but checks for 66% (range: 63-69%)
  #
  # WHAT IT UPDATES:
  #   The "Semi Open" button's visual state (highlighted when blind is ~66%)
  #
  # RELATED UI ELEMENT:
  #   lvgl.yaml → curtain_robot_front_door_66_button
  # ===========================================================================
  #- platform: template
  #  id: curtain_robot_front_door_66
  #  lambda: |-
  #    if (id(curtain_robot_front_door_position).has_state()) {
  #      return abs(id(curtain_robot_front_door_position).state - 66) <= 3;
  #    }
  #    return false;
  #  on_state:
  #    then:
  #      lvgl.widget.update:
  #        id: curtain_robot_front_door_66_button
  #        state:
  #          checked: !lambda return x;

  # ===========================================================================
  # TEMPLATE SENSOR: Blind at 33% (Semi Closed)
  # ===========================================================================
  # WHAT IT DOES:
  #   Calculates whether the blind is at (or very close to) 33% open
  #   Returns TRUE if position is within 3% of 33, FALSE otherwise
  #
  # HOW THE CODE WORKS:
  #   Same logic as above, but checks for 33% (range: 30-36%)
  #
  # WHAT IT UPDATES:
  #   The "Semi Closed" button's visual state (highlighted when blind is ~33%)
  #
  # RELATED UI ELEMENT:
  #   lvgl.yaml → curtain_robot_front_door_33_button
  # ===========================================================================
  #- platform: template
  #  id: curtain_robot_front_door_33
  #  lambda: |-
  #    if (id(curtain_robot_front_door_position).has_state()) {
  #      return abs(id(curtain_robot_front_door_position).state - 33) <= 3;
  #    }
  #    return false;
  #  on_state:
  #    then:
  #      lvgl.widget.update:
  #        id: curtain_robot_front_door_33_button
  #        state:
  #          checked: !lambda return x;

  # ===========================================================================
  # TEMPLATE SENSOR: Blind at 0% (Fully Closed)
  # ===========================================================================
  # WHAT IT DOES:
  #   Calculates whether the blind is at (or very close to) 0% (closed)
  #   Returns TRUE if position is within 3% of 0, FALSE otherwise
  #
  # HOW THE CODE WORKS:
  #   Same logic as above, but checks for 0% (range: 0-3%)
  #
  # WHAT IT UPDATES:
  #   The "Close" button's visual state (highlighted when blind is ~0%)
  #
  # RELATED UI ELEMENT:
  #   lvgl.yaml → curtain_robot_front_door_close_button
  # ===========================================================================
  - platform: template
    id: curtain_robot_front_door_0
    lambda: |-
      if (id(curtain_robot_front_door_position).has_state()) {
        return abs(id(curtain_robot_front_door_position).state - 0) <= 3;
      }
      return false;
    on_state:
      then:
        lvgl.widget.update:
          id: curtain_robot_front_door_close_button
          state:
            checked: !lambda return x;
  
  # Curtain Robot - Kitchen
  - platform: template
    id: curtain_robot_kitchen_100
    lambda: |-
      if (id(curtain_robot_kitchen_position).has_state()) {
        return abs(id(curtain_robot_kitchen_position).state - 100) <= 3;
      }
      return false;
    on_state:
      then:
        lvgl.widget.update:
          id: curtain_robot_kitchen_close_button
          state:
            checked: !lambda return x;

  # ===========================================================================
  # SENSOR: Desk Lights State
  # ===========================================================================
  # WHAT IT MONITORS:
  #   Whether the office storage area lights are on or off
  #   Watches: light.office_storage in Home Assistant
  #
  # WHAT IT UPDATES:
  #   The "Desk Lights" button's visual state (highlighted when on)
  #
  # NOTE: This sensor references a button (desk_lights_button) that
  #       should be defined in lvgl.yaml. If the button doesn't exist,
  #       add it there or remove this sensor.
  #
  # RELATED UI ELEMENT:
  #   lvgl.yaml → storage_lights_button
  # ===========================================================================
  - platform: homeassistant
    id: desk_lights
    entity_id: light.desk_lights
    trigger_on_initial_state: true
    on_state:
      then:
        lvgl.widget.update:
          id: desk_lights_button
          state:
            checked: !lambda return x;
        #- lvgl.widget.update:
        #    id: desk_lights_icon
        #    hidden: !lambda return x;

  # ===========================================================================
  # SENSOR: Lounge Lights State
  # ===========================================================================
  # WHAT IT MONITORS:
  #   Whether the network rack lights are on or off
  #   Watches: light.office_lounge_lights in Home Assistant
  #
  # WHAT IT UPDATES:
  #   The "Lounge Light" button's visual state (highlighted when on)
  #
  # NOTE: This sensor references a button (lounge_lights_button) that
  #       should be defined in lvgl.yaml. If the button doesn't exist,
  #       add it there or remove this sensor.
  #
  # RELATED UI ELEMENT:
  #   lvgl.yaml → lounge_lights_button
  # ===========================================================================
  - platform: homeassistant
    id: lounge_lights
    entity_id: light.lounge_lights
    trigger_on_initial_state: true
    on_state:
      then:
        lvgl.widget.update:
          id: lounge_lights_button
          state:
            checked: !lambda return x;

  # ===========================================================================
  # Automation: Fingerbot
  # ===========================================================================
  # RELATED UI ELEMENT:
  #   lvgl.yaml → automation_fingerbot_lounge_toggle
  # ===========================================================================
  - platform: homeassistant
    id: fingerbot_lounge_toggle
    entity_id: binary_sensor.fingerbot_lounge_toggle
    trigger_on_initial_state: false
    on_state:
      then:
        lvgl.widget.update:
          id: fingerbot_lounge_toggle_button
          state:
            checked: !lambda return x;
